#! /bin/bash

usage() {
	echo "Usage: ./${0##*/} [options] args-for-make
Available options are
  -q  quiet
  -n  Stop after ./configure, i.e. do not run make"
}

die() {
	echo "$1"
	exit ${2:-1}
}

QUIET=''
EARLYSTOP=''
while getopts 'qn?hH' OPTION; do
case "$OPTION" in
  q) QUIET='&>/dev/null';;
  n) EARLYSTOP=1;;
  *) Usage;;
esac
done
shift $((OPTIND-1))

if ! [[ -e Makefile ]]; then
	if ! [[ -e configure && -e Makefile.in ]]; then
		echo "Running autotools..."
		eval ./autogen.sh $QUIET || die "autogen failed"
	fi
	echo "Running configure..."
	eval ./configure $QUIET || die "configure failed"
fi
[[ "$EARLYSTOP" ]] && exit 0
echo "Making $@..."
MAKEEXEC="$(type -P make)" || die "cannot find make"
if [[ "$QUIET" ]]; then
	exec "$MAKEEXEC" "$@" &>/dev/null
else
	exec "$MAKEEXEC" "$@"
fi
