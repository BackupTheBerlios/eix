#! /bin/bash

Usage() {
	echo "Usage: ./${0##*/} [options] args-for-make
Available options are
  -q  quiet
  -n  Stop after ./configure, i.e. do not run make
  -e  Keep environment - do not modify LDFLAGS, CXXFLAGS, CFLAGS
  -c  Use only debugging-safe CXXFLAGS"
	exit ${1}
}

die() {
	echo "$1"
	exit ${2:-1}
}

QUIET=''
EARLYSTOP=''
KEEPENV=''
SAVEFLAGS=''
while getopts 'qnec?hH' OPTION; do
case "$OPTION" in
	q) QUIET='&>/dev/null';;
	n) EARLYSTOP=1;;
	e) KEEPENV='';;
	c) SAFEFLAGS=1;;
	*) Usage 1;;
esac
done
shift $((OPTIND-1))

if [[ -z "${KEEPENV}" ]]; then
	MARCH=$(sed -n 's/^CFLAGS *= *.*-march=\([^ \"]*\)[ \"].*/\1/p' \
		/etc/make.conf)
	export LDFLAGS='-Wl,--sort-common -Wl,-O1 -Wl,-z,combreloc -Wl,--relax -Wl,-z,now'
	export CFLAGS="-march=${MARCH} -O2 -pipe"
	CFLAGS="${CFLAGS} -g -ggdb3 -Wall -Werror"
	[[ "${SAFEFLAGS}" ]] || CFLAGS="${CFLAGS} -fomit-frame-pointer -O3 -O4 -fno-ident -fPIC -ftracer -ftree-vectorize -ftree-vectorizer-verbose=0 -funswitch-loops -frename-registers -fweb -finline-functions -fgcse-after-reload -DNDEBUG -DG_DISABLE_ASSERT -DNO_DEBUG -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE"
	export CXXFLAGS="${CFLAGS}"
	[[ "${SAFEFLAGS}" ]] || CXXFLAGS="${CXXFLAGS} -fvisibility-inlines-hidden -fno-enforce-eh-specs"
fi
if ! [[ -e Makefile ]]; then
	if ! [[ -e configure && -e Makefile.in ]]; then
		echo "Running autotools..."
		eval ./autogen.sh $QUIET || die "autogen failed"
	fi
	echo "Running configure..."
	eval ./configure --with-sqlite $QUIET || die "configure failed"
fi
[[ "$EARLYSTOP" ]] && exit 0
echo "Making $@..."
MAKEEXEC="$(type -P make)" || die "cannot find make"
if [[ "$QUIET" ]]; then
	exec "$MAKEEXEC" "$@" &>/dev/null
else
	exec "$MAKEEXEC" "$@"
fi
