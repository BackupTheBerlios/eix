#! /usr/bin/env sh

export LC_ALL=C

Usage () {
	printf "%s\n" "Usage: ${0##*/} [options] args-for-make
Available options are
  -q  quiet
  -n  Stop after ./configure, i.e. do not run make
  -e  Keep environment - do not modify LDFLAGS, CXXFLAGS, CFLAGS
  -0  Do not pass --add-extra-cache=yes to ./configure
  -1/2/3 Generate 1/2/3 binaries for eix-{,diff,update}
  -4  Enable separate tools
  -p  Use pedantic warnings (but no error on warnings) when modifying flags
  -u  Define NOT_FULL_USE
  -s  With sqlite
  -S  Without sqlite
  -b  With bzlib
  -B  Without bzlib
  -c  Use only debugging-safe CXXFLAGS
  -C  Avoid CCACHE
  -jX Use -jX (currently ${jarg})
  -r  Change also directory permissions to root (for fakeroot-ng)"
	exit ${1:-1}
}

Info () {
	${quiet} && return
	printf "%s\n" "${*}"
}

Die () {
	printf "%s: %s\n" "${0##*/}" "${1}"
	exit ${2:-1}
}

SetCcache () {
	local i j
	i='/usr/lib/ccache/bin'
	test -d "${i}" || return
	case "${PATH}" in
		"${i}:"*|*":${i}:"*) return;;
	esac
	if [ -n "${PATH}" ]
	then
		Info "PATH=${i}:\${PATH}"
		PATH="${i}:${PATH}"
	fi
	[ -n "${CCACHE_DIR}" ] && return
	for i in "${HOME}/.ccache" ../ccache ../../ccache
	do
		[ -z "${i}" ] && continue
		j=`readlink -f -- "${i}"` && [ -n "${j}" ] \
			&& test -d "${j}" && break
	done
	[ -z "${j}" ] && return
	Info "CCACHE_DIR=${j}"
	export CCACHE_DIR
	CCACHE_DIR="${j}"
}


quiet=false
earlystop=false
keepenv=false
safeflags=false
not_full_use=false
sqlite=''
bzlib=''
pedantic=false
extra_cache='--enable-extra-cache'
separate=''
use_chown=false
jarg='-j3'
use_ccache=true
OPTIND=1
while getopts 'q0123nepusSbBcrj:?hH' opt
do
case "${opt}" in
	q) quiet=true;;
	0) extra_cache='';;
	1) separate='--disable-separate-binaries';;
	2) separate='--enable-separate-update';;
	3) separate='--enable-separate-binaries';;
	4) separate='--enable-separate-tools';;
	n) earlystop=true;;
	e) keepenv=true;;
	p) pedantic=true;;
	u) not_full_use=true;;
	s) sqlite='--with-sqlite';;
	S) sqlite='--without-sqlite';;
	b) bzlib='--with-bzip2';;
	B) bzlib='--without-bzip2';;
	c) safeflags=true;;
	C) use_ccache=false;;
	r) use_chown=true;;
	j) [ -n "${OPTARG}" ] && jarg='-j${OPTARG}' || jarg='';;
	*) Usage 0;;
esac
done
if [ ${OPTIND} -gt 1 ]
then
	( eval '[ "$(( 0 + 1 ))" = 1 ]' ) >/dev/null 2>&1 &&
	eval 'shift "$(( ${OPTIND} - 1 ))"' || shift "`expr ${OPTIND} - 1`"
fi

${quiet} && quietredirect='>/dev/null 2>&1' || quietredirect=''

if ${use_chown}
then
	ls /root >/dev/null 2>&1 && \
		Die "You should not really be root when you use -r" 2
	chown -R root:root .
fi

${use_ccache} && SetCcache

if ! ${keepenv}
then
	march="`sed -n 's/^CFLAGS *= *.*-march=\([^ \"]*\)[ \"].*/\1/p' \
		/etc/make.conf`"
	export CXXFLAGS CFLAGS LDFLAGS
	LDFLAGS='-Wl,--sort-common -Wl,-O1 -Wl,-z,combreloc -Wl,--relax -Wl,-z,now'
	LDFLAGS="${LDFLAGS} -Wl,-z,defs -Wl,--no-undefined -Wl,--no-allow-shlib-undefined -Wl,--no-undefined-version -Wl,--warn-common -Wl,--fatal-warnings"
	CFLAGS="-march=${march} -O2 -pipe -funsigned-char"
	${safeflags} || CFLAGS="${CFLAGS} -fomit-frame-pointer -O3 -O4 -fno-ident -fPIC -ftracer -funsafe-loop-optimizations -ftree-vectorize -ftree-vectorizer-verbose=0 -funswitch-loops -frename-registers -fweb -finline-functions -fgcse-after-reload -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE"
	${not_full_use} && CFLAGS="${CFLAGS} -DNOT_FULL_USE"
	CFLAGS="${CFLAGS} -D_GLIBCXX_DEBUG -g -ggdb3 -Wall -Wextra"
	${safeflags} || CFLAGS="${CFLAGS} -pedantic"
	if ${pedantic}
	then
		CFLAGS="${CFLAGS} -fstrict-aliasing -fstack-protector"
		CFLAGS="${CFLAGS} -Wformat=2 -Winit-self -Wmissing-include-dirs -Wswitch-default -Wunused -Wunused-parameter -Wstrict-aliasing=1 -Wstrict-overflow=5"
		CFLAGS="${CFLAGS} -Wfloat-equal  -Wundef -Wshadow -Wunsafe-loop-optimizations -Wpointer-arith -Wcast-qual -Wcast-align -Wwrite-strings -Wsign-compare -Wmissing-field-initializers -Wmissing-noreturn -Wnormalized=nfkc -Wpacked -Wredundant-decls -Winvalid-pch -Wlong-long -Wvolatile-register-var -Wdisabled-optimization"
		#CFLAGS="${CFLAGS} -Wconversion"
		#CFLAGS="${CFLAGS} -Wunreachable-code -Wpadded"
		#CFLAGS="${CFLAGS} -Wswitch-enum -Waggregate-return -Winline -Wmissing-format-attribute"
		# gcc-4.3:
		CFLAGS="${CFLAGS} -Wlogical-op -Wsign-conversion -Wvla"
		CXXFLAGS="${CFLAGS} -Wabi -Wctor-dtor-privacy -Wstrict-null-sentinel -Wold-style-cast -Woverloaded-virtual -Wsign-promo"
		#CXXFLAGS="${CXXFLAGS} -Weffc++ "
		CFLAGS="${CFLAGS} -Wtraditional -Wc++-compat -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wnested-externs -Wpointer-sign"
		#CXXFLAGS="${CXXFLAGS} -Werror"
	else
		${safeflags} || CFLAGS="${CFLAGS} -DNDEBUG -DG_DISABLE_ASSERT -DNO_DEBUG"
		CXXFLAGS="${CFLAGS} -Werror"
	fi
	${safeflags} || CXXFLAGS="${CXXFLAGS} -fvisibility-inlines-hidden -fno-enforce-eh-specs"
fi
Info "CFLAGS=${CFLAGS}
CXXFLAGS=${CXXFLAGS}
LDFLAGS=${LDFLAGS}"
if ! test -e Makefile
then
	if ! test -e configure || ! test -e Makefile.in
	then
		echo "Running autotools..."
		eval ./autogen.sh ${quietredirect} || Die "autogen failed"
	fi
	echo "Running configure..."
	eval ./configure "--prefix=" ${sqlite} ${bzlib} ${extra_cache} ${separate} ${quietredirect} || \
		Die "configure failed"
fi
${earlystop} && {
	exec make ${jarg} config.h || Die "cannot exec make"
}
echo "Making ${*}..."
command -v make >/dev/null 2>&1 || Die "cannot find make"
if ${quiet}
then
	exec make ${jarg} "${@}" >/dev/null 2>&1
else
	exec make ${jarg} "${@}"
fi
