#! /bin/sh
# This script is part of the eix project and distributed under the
# terms of the GNU General Public License v2.
#
# Author and Copyright (c):
#   Martin V\"ath <vaeth@mathematik.uni-wuerzburg.de>
#
# This file must be "source"d by POSIX scripts.
#
# It can add or remove local layman overlays to the current eix
# database. (@PACKAGE_STRING@).

. update-eix-functions.sh.in

Usage() {
	local I R="${1}"
	echo "Usage: ${0##*/} [options] command
Add or remove local layman overlays to eix database (@PACKAGE_STRING@)
The following commands are provided:

add:	Add the local layman overlays to the eix database
remove:	Remove the local layman overlays from the eix database.

Options:
	-a OVERLAY  Add overlay to the list of layman overlays.
	-A PATH     Add PATH to the sourced make.conf's used to determine
	            the layman overlays. Current value:"
	eval "set -- ${LAYMAN_MAKE}"
	for I; do
		echo \
"	            	${I}"
	done
	echo \
"	-C          Clear the above list.
	-v          Verbose (default)
	-q          Quiet"
	exit ${R}
}

ClearLayman () {
	LAYMAN_MAKE=''
}

GetPortdir
ClearLayman
Push LAYMAN_MAKE "${LOCAL_PORTDIR:-/}local/layman/make.conf"
LAYMAN_OVERLAYS=''

while getopts 'vqa:A:C?hH' OPTION; do
	case "${OPTION}" in
		v) VERBOSE=true;;
		q) VERBOSE=false;;
		a) Push LAYMAN_OVERLAYS "${OPTARG}";;
		A) Push LAYMAN_MAKE "${OPTARG}";;
		C) ClearLayman;;
		*) Usage 0;;
	esac
done
shift $(( ${OPTIND} - 1 ))

GetOverlays () {
	local I
	eval "set -- ${A}"
	for I; do
		[ -n "${I}" ] || continue
		test -r "${I}" || die "cannot read ${I}"
		Push LAYMAN_OVERLAYS \
			$(PORTDIR_OVERLAY=''; . "${I}"; \
				echo "${PORTDIR_OVERLAY}")
	done
}

Init () {
	ClearUpdateEixArgs
	GetOverlays
	AddLocalMethods
}

Add () {
	Init
	eval "AddOverlays ${LAYMAN_OVERLAYS}"
	CallUpdateEix
}

Remove () {
	Init
	eval "AddExcludes ${LAYMAN_OVERLAYS}"
	CallUpdateEix
}

MAIN_COMMAND="${1}"
[ $# -gt 0 ] && shift

case "${MAIN_COMMAND}" in
	add*)               Add "${@}";;
	rem*|del*|rm*|sub*) Remove "${@}";;
	*)                  Usage 1;;
esac

exit 0
