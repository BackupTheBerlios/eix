#!/bin/bash

proj="eix"
svnroot="http://dev.croup.de/repos/${proj}"

usage() {
	echo "Usage: mkrelease"
	echo "Verify in advance to have AC_INIT set correctly in configure.in"
}

die() {
	echo "$1"
	exit ${2:-1}
}

ver=$(grep AC_INIT configure.in | awk '{ print $2 }')
ver=${ver/,}

ans=''
while [[ -z "${ans}" ]]; do
	read -p "Are you sure you want to release ${proj}-${ver}? (y/n) " ans
	case "${ans}" in
		n) echo "Not releasing anything"; exit 1;;
		y) ;;
		*) if [[ "${ans}" ]]; then
			echo "Unknown answer: ${ans}"
			exit 2
		fi;;
	esac
done
echo "Creating release tag... "

svn copy ${svnroot}/trunk ${svnroot}/tags/release-${ver} \
	-m "Tagging the ${ver} release of the ${proj} project" &>/dev/null || die "svn copy failed"

exit 0

echo "Running autotools..."

make -f Makefile.cvs &>/dev/null || die "make failed"
mkdir build &>/dev/null
pushd build/ &>/dev/null || die "popd failed"

echo "Make dist tarball..."
../configure &>/dev/null || die "configure failed"
make dist &>/dev/null || die "make dist failed"

for i in *.tar*; do
	md5sum $i > $i.md5
done

echo "Tarball ist at `pwd`"

popd &>/dev/null || die "popd failed"
