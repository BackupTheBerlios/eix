AC_INIT(eix, 0.5.0_pre2, http://sourceforge.net/projects/eix/)
AC_CANONICAL_TARGET

AM_CONFIG_HEADER(config.h)
AM_INIT_AUTOMAKE()


AC_LANG_CPLUSPLUS

AC_PROG_LN_S
AC_PROG_CXX
AM_PROG_LIBTOOL

dnl Look for basic functions
AC_CHECK_FUNCS([regcomp strchr strcspn strdup strerror strstr strspn strtol strrchr fnmatch memset], ,
			   AC_MSG_ERROR(We really need those functions ..))

dnl Well define our own strndup if we don't have one
AC_CHECK_FUNCS(strndup, , )

AC_CHECK_PROGS(regex_cmd, sed)
if test x$regex_cmd = "x"; then
	  AC_MSG_ERROR([error. sed is required to build the manpage.])
fi

dnl Check what type of argument scandir wants
AC_MSG_CHECKING(if scandir argument is const struct dirent * or struct dirent *)
AC_TRY_COMPILE([ #include <dirent.h>
],
[
  const char * dir = 0;
  struct dirent ***namelist = 0;
  int (*select)(const struct dirent *) = 0;
  scandir(dir, namelist, select, alphasort);
],
[AC_MSG_RESULT(const struct dirent *); SCANDIR_ARG3="const struct dirent *"],
	AC_TRY_COMPILE([ #include <dirent.h>
	],
	[
	  const char * dir = 0;
	  struct dirent ***namelist = 0;
	  int (*select)(struct dirent *) = 0;
	  scandir(dir, namelist, select, alphasort);
	],
	[AC_MSG_RESULT(struct dirent *); SCANDIR_ARG3="struct dirent *"],
	AC_MSG_ERROR(none of them .. I don't know how to call scandir)
	)
)

AC_DEFINE_UNQUOTED(SCANDIR_ARG3, $SCANDIR_ARG3, "3th argument of scandir")

dnl Check endianess
AC_C_BIGENDIAN

#AC_CHECK_FUNCS([munmap], , 
#			   AC_MSG_ERROR(No munmap, no eix.))
#AC_CHECK_FUNCS([strcasecmp], ,
#			   AC_MSG_ERROR(No strcasecmp, no eix.))
#AC_CHECK_HEADERS([fcntl.h], ,
#			   AC_MSG_ERROR(No fcntl.h?))

#AC_REPLACE_FNMATCH
#AC_TYPE_OFF_T
#AC_TYPE_UID_T
#AC_TYPE_SIGNAL
#AC_TYPE_SIZE_T 

#AC_C_CONST 
#AC_C_INLINE 

#AC_FUNC_CHOWN
#AC_FUNC_CLOSEDIR_VOID 
#AC_FUNC_FSEEKO
#AC_FUNC_STAT 
#AC_FUNC_MMAP

#AC_HEADER_DIRENT 
#AC_HEADER_STDBOOL 

AM_CFLAGS=""
AM_CXXFLAGS=""

#AC_ARG_ENABLE(diff-eix,[  --enable-diff-eix Build and install diff-eix.],
#			  diff_eix="$enableval",
#			  diff_eix="no")

#AM_CONDITIONAL([BUILD_DIFF_EIX],
#		   [test x"$diff_eix" = "xyes"])

AC_ARG_ENABLE(debug,[  --enable-debug  Enables debug cxxflags.],
		[AM_CXXFLAGS="$AM_CXXFLAGS -Werror -ansi -fno-inline -Wno-unused -g3 -ggdb3"],
		)

dnl Check for cache-file argument
AC_ARG_WITH(cachefile,[  --with-cachefile=FILE   Location of the cachefile (default /var/cache/eix)],
		[EIX_CACHEFILE=$withval],
		[EIX_CACHEFILE=/var/cache/eix])

AC_DEFINE_UNQUOTED(EIX_CACHEFILE, "$EIX_CACHEFILE", Location of the cachefile)

AC_ARG_WITH(max-levenshtein-distance,[  --with-max-levenshtein-distance=N  Maximal levenshtein-distance of N (default 2)],
		[LEVENSHTEIN_DISTANCE=$withval],
		[LEVENSHTEIN_DISTANCE=2])

AC_DEFINE_UNQUOTED(LEVENSHTEIN_DISTANCE, $LEVENSHTEIN_DISTANCE, Maximal levenshtein-distance for matches)
AC_DEFINE_UNQUOTED(LEVENSHTEIN_DISTANCE_STR, "$LEVENSHTEIN_DISTANCE", Maximal levenshtein-distance for matches (as string))

EIX_WIKI="http://dev.croup.de/proj/eix"

AC_DEFINE_UNQUOTED(EIX_WIKI, "$EIX_WIKI", Location of eix-wiki)

AC_SUBST(EXTRA_CXXFLAGS)
AC_SUBST(LEVENSHTEIN_DISTANCE)
AC_SUBST(EIX_CACHEFILE)
AC_SUBST(PACKAGE_STRING)
AC_SUBST(EIX_WIKI)
AC_SUBST(AM_CXXFLAGS)

AC_DEFINE_UNQUOTED(TARGET, "$target", Target system)

if test "x$GCC" != x; then
	AC_MSG_CHECKING(gcc version)
	gcc_v=`${CC} -dumpversion`
	AC_DEFINE_UNQUOTED(GCC_VERSION, "$gcc_v", Version of gcc)
	AC_MSG_RESULT($gcc_v)
fi

dnl Done!
AC_OUTPUT(Makefile manpage/Makefile
		  src/Makefile
		  src/eixTk/Makefile

		  src/database/Makefile

		  src/portage/Makefile
		  src/portage/cache/Makefile
		  src/portage/conf/Makefile

		  src/output/Makefile
		  
		  contrib/Makefile)

echo ""
echo " $PACKAGE version $VERSION configured successfully."
echo " Good luck with make :)" 
