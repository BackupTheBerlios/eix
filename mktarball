#! /usr/bin/env sh

export LC_ALL=C

Usage() {
	printf "%s\n" "Usage: ${0##*/} [all|bzip2]
If you do not want autodetection of fakeroot-ng/fakeroot,
define FAKEROOT correspondingly"
	exit ${1}
}

Die() {
	printf "%s: %s\n" "${0##*/}" "${1}"
	exit ${2:-1}
}

Run() {
	printf "%s\n" "${*}"
	"${@}" || Die "${*} failed" ${?}
}

MAKEARCH="dist-lzma"
[ ${#} -ne 0 ] && [ -n "${1}" ] && case "${1}" in
	h*|H*|*\?*|-*) Usage;;
	b*|B*) MAKEARCH="dist-bzip2";;
	l*|L*|'') :;;
	*) MAKEARCH="${MAKEARCH} dist";;
esac

test -e Makefile || test -e configure || test -e Makefile.in && Run ./mksvnclean

unset LDFLAGS CFLAGS CXXFLAGS
[ -z "${FAKEROOT}" ] && command -v fakeroot >/dev/null 2>&1 && FAKEROOT=fakeroot
[ -z "${FAKEROOT}" ] && command -v fakeroot-ng >/dev/null 2>&1 && FAKEROOT=fakeroot-ng
if command -v "${FAKEROOT}" >/dev/null 2>&1
then
	Run ./mkmake -0eqn
	DOCMD="${FAKEROOT} ./mkmake -0qr"
else
	DOCMD="./mkmake -0eq"
fi
for i in ${MAKEARCH}
do
	Run ${DOCMD} "${i}"
done

found=false
for j in tar.lzma tar.bz2 tar.gz zip tar.Z shar.gz shar
do
	for i in "${PWD}"/eix-*."${j}"
	do
		test -f "${i}" || continue
		${found} || echo "Available tarballs:"
		found=true
		printf "\t%s\n" "${i}"
	done
done
${found} || Die "For some reason no tarball was created"
echo "The tarballs will be removed with ./mksvnclean
To install with portage run as root ./mkemerge
To tag the release in svn you should run ./mkrelease"
