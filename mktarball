#! /usr/bin/env sh

export LC_ALL=C

makearch=''
fakeroot=''
[ -z "${fakeroot}" ] && command -v fakeroot >/dev/null 2>&1 && fakeroot='fakeroot'
[ -z "${fakeroot}" ] && command -v fakeroot-ng >/dev/null 2>&1 && fakeroot='fakeroot-ng'

Usage() {
	printf "%s\n" "Usage: ${0##*/} [options] xz|lzma|bzip2|gzip|default
Options: -fakeroot, -fakeroot-ng, -no-fakeroot (default is -${fakeroot})"
	exit ${1:-1}
}

Die() {
	printf "%s: %s\n" "${0##*/}" "${1}"
	exit ${2:-1}
}

Run() {
	printf "%s\n" "${*}"
	"${@}" || Die "${*} failed" ${?}
}

while [ ${#} -gt 0 ]
do
	opt="${1#-}"
	opt="${opt#-}"
	case "${opt#dist-}" in
		x*|X*) makearch="${makearch} dist-xz";;
		l*|L*) makearch="${makearch} dist-lzma";;
		b*|B*) makearch="${makearch} dist-bzip2";;
		g*|G*) makearch="${makearch} dist-gzip";;
		d*|D*) makearch="${makearch} dist";;
		f*ng) fakeroot='fakeroot-ng';;
		f*) fakeroot='fakeroot';;
		F*|n*f*) fakeroot='';;
		help|h|H|\?) Usage 0;;
		*) Usage;;
	esac
	shift
done
[ -z "${makearch}" ] && Usage

test -e Makefile || test -e configure || test -e Makefile.in && Run ./mksvnclean

unset LDFLAGS CFLAGS CXXFLAGS
if [ -n "${fakeroot}" ] && command -v "${fakeroot}" >/dev/null 2>&1
then
	Run ./mkmake -0eqn
	docmd="${fakeroot} ./mkmake -0qr"
else
	docmd="./mkmake -0eq"
fi
for i in ${makearch}
do
	Run ${docmd} "UPDATEPOFILES=" "${i}"
done

found=false
for j in tar.xz tar.lzma tar.bz2 tar.gz zip tar.Z shar.gz shar
do
	for i in "${PWD}"/eix-*."${j}"
	do
		test -f "${i}" || continue
		${found} || echo "Available tarballs:"
		found=true
		printf "\t%s\n" "${i}"
	done
done
${found} || Die "For some reason no tarball was created"
printf "%s\n" \
"The tarballs will be removed with ./mksvnclean
To install with portage run as root ./mkemerge
To tag the release in svn you should run ./mkrelease"
